#!/bin/sh
set -eu

# Determine script location and workspace path
SCRIPT_DIR=$(dirname "$(realpath "$0")")
WORKSPACE_RUBY_LSP_DIR="$(dirname "$SCRIPT_DIR")/.ruby-lsp"
PORT_FILE="$WORKSPACE_RUBY_LSP_DIR/mcp-port"
LOG_FILE="$WORKSPACE_RUBY_LSP_DIR/mcp-bridge.log"

# Ensure log directory exists
mkdir -p "$WORKSPACE_RUBY_LSP_DIR"

# Check if port file exists
if [ ! -f "$PORT_FILE" ]; then
  echo "Error: MCP port file not found at $PORT_FILE" >&2
  echo "MCP server may not be running." >&2
  exit 1
fi

# Read port from file
PORT=$(cat "$PORT_FILE")

echo "Bridge started using TCP port $PORT" >> "$LOG_FILE"

while IFS= read -r line; do
  echo "================================" >> "$LOG_FILE"
  echo "Input JSON: $line" >> "$LOG_FILE"

  # Send JSON-RPC request directly over TCP
  response=$(echo "$line" | nc 127.0.0.1 "$PORT" 2>>"$LOG_FILE") || {
    echo "TCP connection failed" >> "$LOG_FILE"
    continue
  }

  echo "--------------------------------" >> "$LOG_FILE"
  echo "Response JSON: $response" >> "$LOG_FILE"

  echo "$response"
done
