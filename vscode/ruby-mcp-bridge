#!/bin/bash

# Determine script location and workspace path
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_RUBY_LSP_DIR="$(dirname "$SCRIPT_DIR")/.ruby-lsp"
PORT_FILE="$WORKSPACE_RUBY_LSP_DIR/mcp-port"
LOG_PATH="$WORKSPACE_RUBY_LSP_DIR/mcp-bridge.log"

# Ensure log directory exists
mkdir -p "$WORKSPACE_RUBY_LSP_DIR"

# Check if port file exists
if [ ! -f "$PORT_FILE" ]; then
  echo "Error: MCP port file not found at $PORT_FILE" >&2
  echo "MCP server may not be running." >&2
  exit 1
fi

# Read port from file
PORT=$(cat "$PORT_FILE")

echo "Bridge started using port $PORT" >> "$LOG_PATH"

while IFS= read -r line; do
  echo "================================" >> "$LOG_PATH"
  echo "Input JSON: $line" >> "$LOG_PATH"

  # Send to TCP socket using netcat (nc)
  response=$(echo -e "POST /mcp HTTP/1.1\r\nContent-Type: application/json\r\nContent-Length: ${#line}\r\n\r\n$line" | \
    nc -w 2 127.0.0.1 "$PORT" 2>/dev/null) || {
    echo "Socket communication failed" >> "$LOG_PATH"
    continue
  }

  # Extract the JSON response by removing HTTP headers
  json_response=$(echo "$response" | awk 'BEGIN{RS="\r\n\r\n"} NR==2')

  echo "--------------------------------" >> "$LOG_PATH"
  echo "Response JSON: $json_response" >> "$LOG_PATH"

  echo "$json_response"
done
