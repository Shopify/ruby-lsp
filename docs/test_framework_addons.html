<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/ruby-lsp/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/ruby-lsp/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(1)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(1) > ul > li:nth-child(3) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(1) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(1) > ul > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(1) > ul > li:nth-child(3) > ul > li:nth-child(1) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(1) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; } </style> <script src="/ruby-lsp/assets/js/vendor/lunr.min.js"></script> <script src="/ruby-lsp/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Test framework add-ons | Ruby LSP</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Test framework add-ons" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="An opinionated language server for Ruby. Batteries included!" /> <meta property="og:description" content="An opinionated language server for Ruby. Batteries included!" /> <link rel="canonical" href="https://shopify.github.io/ruby-lsp/test_framework_addons.html" /> <meta property="og:url" content="https://shopify.github.io/ruby-lsp/test_framework_addons.html" /> <meta property="og:site_name" content="Ruby LSP" /> <meta property="og:image" content="https://shopify.github.io/ruby-lsp/icon.png" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://shopify.github.io/ruby-lsp/icon.png" /> <meta property="twitter:title" content="Test framework add-ons" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"An opinionated language server for Ruby. Batteries included!","headline":"Test framework add-ons","image":"https://shopify.github.io/ruby-lsp/icon.png","url":"https://shopify.github.io/ruby-lsp/test_framework_addons.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/ruby-lsp/" class="site-title lh-tight"> Ruby LSP </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Ruby LSP category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/ruby-lsp/" class="nav-list-link">Ruby LSP</a><ul class="nav-list"><li class="nav-list-item"><a href="/ruby-lsp/editors.html" class="nav-list-link">Editors</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in VS Code extension category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/ruby-lsp/vscode-extension.html" class="nav-list-link">VS Code extension</a><ul class="nav-list"><li class="nav-list-item"><a href="/ruby-lsp/test_explorer.html" class="nav-list-link">Test explorer</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Add-ons category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/ruby-lsp/add-ons.html" class="nav-list-link">Add-ons</a><ul class="nav-list"><li class="nav-list-item"><a href="/ruby-lsp/test_framework_addons.html" class="nav-list-link">Test framework add-ons</a></li></ul></li><li class="nav-list-item"><a href="/ruby-lsp/design-and-roadmap.html" class="nav-list-link">Design and roadmap</a></li><li class="nav-list-item"><a href="/ruby-lsp/semantic-highlighting.html" class="nav-list-link">Semantic Highlighting for Themes</a></li><li class="nav-list-item"><a href="/ruby-lsp/composed-bundle.html" class="nav-list-link">Composed Ruby LSP bundle</a></li></ul></li><li class="nav-list-item"><a href="/ruby-lsp/rails-add-on.html" class="nav-list-link">Rails add-on</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Troubleshooting category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/ruby-lsp/troubleshooting.html" class="nav-list-link">Troubleshooting</a><ul class="nav-list"><li class="nav-list-item"><a href="/ruby-lsp/version-managers.html" class="nav-list-link">Version Managers</a></li></ul></li><li class="nav-list-item"><a href="/ruby-lsp/contributing.html" class="nav-list-link">Contributing</a></li><li class="nav-list-item"><a href="/ruby-lsp/supported_versions.html" class="nav-list-link">Supported Versions Policy</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/Shopify/ruby-lsp" class="nav-list-link external" target="_blank" rel="noopener noreferrer" > Ruby LSP on GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li><li class="nav-list-item external"> <a href="https://github.com/Shopify/ruby-lsp-rails" class="nav-list-link external" target="_blank" rel="noopener noreferrer" > Ruby LSP Rails on GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Ruby LSP" aria-label="Search Ruby LSP" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://shopify.github.io/ruby-lsp/invite" class="site-button" > Ruby DX Slack </a> </li> <li class="aux-nav-list-item"> <a href="https://github.com/Shopify/ruby-lsp/issues/new/choose" class="site-button" > Report an Issue </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/ruby-lsp/">Ruby LSP</a></li> <li class="breadcrumb-nav-list-item"><a href="/ruby-lsp/add-ons.html">Add-ons</a></li> <li class="breadcrumb-nav-list-item"><span>Test framework add-ons</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="test-framework-add-ons"> <a href="#test-framework-add-ons" class="anchor-heading" aria-labelledby="test-framework-add-ons"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Test framework add-ons </h1> <p class="note">Before diving into building test framework add-ons, read about the <a href="test_explorer">test explorer documentation</a> first.</p> <p>The Ruby LSP’s test explorer includes built-in support for Minitest and Test Unit. Add-ons can add support for other test frameworks, like <a href="rails-add-on">Active Support test case</a> and <a href="https://github.com/st0012/ruby-lsp-rspec">RSpec</a>.</p> <p>There are 3 main parts for contributing support for a new framework:</p> <ul> <li><a href="#test-discovery">Test discovery</a>: identifying tests within the codebase and their structure</li> <li><a href="#command-resolution">Command resolution</a>: determining how to execute a specific test or group of tests</li> <li><a href="#custom-reporting">Custom reporting</a>: displaying test execution results in the test explorer</li> </ul> <h2 id="test-discovery"> <a href="#test-discovery" class="anchor-heading" aria-labelledby="test-discovery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Test discovery </h2> <p>Test discovery is the process of populating the explorer view with the tests that exist in the codebase. The Ruby LSP extension is responsible for discovering all test files. The convention to be considered a test file is that it must match this glob pattern: <code class="language-plaintext highlighter-rouge">**/{test,spec,features}/**/{*_test.rb,test_*.rb,*_spec.rb,*.feature}</code>. It is possible to configure test frameworks to use different naming patterns, but this convention is established to guarantee that we can discover all test files with adequate performance and without requiring configuration from users.</p> <p>The part that add-ons are responsible for is discovering which tests exist <strong>inside</strong> of those files, which requires static analysis and rules that are framework dependent. Like most other add-on contribution points, test discovery can be enhanced by attaching a new listener to the process of discovering tests.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">RubyLsp</span>
  <span class="k">module</span> <span class="nn">MyTestFrameworkGem</span>
    <span class="k">class</span> <span class="nc">Addon</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">RubyLsp</span><span class="o">::</span><span class="no">Addon</span>
      <span class="c1">#: (GlobalState, Thread::Queue) -&gt; void</span>
      <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="n">global_state</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">)</span>
        <span class="vi">@global_state</span> <span class="o">=</span> <span class="n">global_state</span>
      <span class="k">end</span>

      <span class="c1"># Declare the factory method that will hook a new listener into the test discovery process</span>
      <span class="c1"># @override</span>
      <span class="c1">#: (ResponseBuilders::TestCollection, Prism::Dispatcher, URI::Generic) -&gt; void</span>
      <span class="k">def</span> <span class="nf">create_discover_tests_listener</span><span class="p">(</span><span class="n">response_builder</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="c1"># Because the Ruby LSP runs requests concurrently, there are no guarantees that we'll be done executing</span>
        <span class="c1"># activate when a request for test discovery comes in. If this happens, skip until the global state is ready</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="vi">@global_state</span>

        <span class="c1"># Create our new test discovery listener, which will hook into the dispatcher</span>
        <span class="no">TestDiscoveryListener</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">response_builder</span><span class="p">,</span> <span class="vi">@global_state</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Next, the listener itself needs to be implemented. If the test framework being handled uses classes to define test groups, like Minitest and Test Unit, the Ruby LSP provides a parent class to make some aspects of the implementation easier and more standardized. Let’s take a look at this case first and then see how frameworks that don’t use classes can be handled (such as RSpec).</p> <p>In this example, test groups are defined with classes that inherit from <code class="language-plaintext highlighter-rouge">MyTestFramework::Test</code> and test examples are defined by creating methods prefixed with <code class="language-plaintext highlighter-rouge">test_</code>.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">RubyLsp</span>
  <span class="k">module</span> <span class="nn">MyTestFrameworkGem</span>
    <span class="k">class</span> <span class="nc">TestDiscoveryListener</span> <span class="o">&lt;</span> <span class="no">Listeners</span><span class="o">::</span><span class="no">TestDiscovery</span>
      <span class="c1">#: (ResponseBuilders::TestCollection, GlobalState, Prism::Dispatcher, URI::Generic) -&gt; void</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">response_builder</span><span class="p">,</span> <span class="n">global_state</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="k">super</span><span class="p">(</span><span class="n">response_builder</span><span class="p">,</span> <span class="n">global_state</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>

        <span class="c1"># Register on the dispatcher for the node events we are interested in</span>
        <span class="n">dispatcher</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:on_class_node_enter</span><span class="p">,</span> <span class="ss">:on_def_node_enter</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1">#: (Prism::ClassNode node) -&gt; void</span>
      <span class="k">def</span> <span class="nf">on_class_node_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># Here we use the `with_test_ancestor_tracking` so that we can check if the class we just found inherits</span>
        <span class="c1"># from our framework's parent test class. This check is important because users can define any classes or</span>
        <span class="c1"># modules inside a test file and not all of them are runnable tests</span>
        <span class="n">with_test_ancestor_tracking</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="nb">ancestors</span><span class="o">|</span>
          <span class="k">if</span> <span class="nb">ancestors</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"MyTestFrameworkGem::Test"</span><span class="p">)</span>
            <span class="c1"># If the test class indeed inherits from our framework, then we can create a new test item representing</span>
            <span class="c1"># this test in the explorer. The expected arguments are:</span>
            <span class="c1">#</span>
            <span class="c1"># - id: a unique ID for this test item. Must match the same IDs reported during test execution</span>
            <span class="c1"># (explained in the next section)</span>
            <span class="c1"># - label: the label that will appear in the explorer</span>
            <span class="c1"># - uri: the URI where this test can be found (e.g.: file:///Users/me/src/my_project/test/my_test.rb).</span>
            <span class="c1"># has to be a URI::Generic object</span>
            <span class="c1"># - range: a RubyLsp::Interface::Range object describing the range inside of `uri` where we can find the</span>
            <span class="c1"># test definition</span>
            <span class="c1"># - framework: a framework ID that will be used for resolving test commands. Each add-on should only</span>
            <span class="c1"># resolve the items marked as their framework</span>
            <span class="n">test_item</span> <span class="o">=</span> <span class="no">Requests</span><span class="o">::</span><span class="no">Support</span><span class="o">::</span><span class="no">TestItem</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
              <span class="nb">name</span><span class="p">,</span>
              <span class="nb">name</span><span class="p">,</span>
              <span class="vi">@uri</span><span class="p">,</span>
              <span class="n">range_from_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
              <span class="ss">framework: :my_framework</span>
            <span class="p">)</span>

            <span class="c1"># Push the test item as an explorer entry</span>
            <span class="vi">@response_builder</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">test_item</span><span class="p">)</span>

            <span class="c1"># Push the test item for code lenses. This allows users to run tests by clicking the `Run`,</span>
            <span class="c1"># `Run in terminal` and `Debug` buttons directly on top of tests</span>
            <span class="vi">@response_builder</span><span class="p">.</span><span class="nf">add_code_lens</span><span class="p">(</span><span class="n">test_item</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1">#: (Prism::DefNode) -&gt; void</span>
      <span class="k">def</span> <span class="nf">on_def_node_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># If the method is not public, then it cannot be considered an example. The visibility stack is tracked</span>
        <span class="c1"># automatically by the `RubyLsp::Listeners::TestDiscovery` parent class</span>
        <span class="k">return</span> <span class="k">if</span> <span class="vi">@visibility_stack</span><span class="p">.</span><span class="nf">last</span> <span class="o">!=</span> <span class="ss">:public</span>

        <span class="c1"># If the method name doesn't begin with `test_`, then it's not a test example</span>
        <span class="nb">name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">to_s</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nb">name</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span>

        <span class="c1"># The current group of a test example depends on which exact namespace nesting it is defined in. We can use</span>
        <span class="c1"># the Ruby LSP's index to get the fully qualified name of the current namespace using the `@nesting` variable</span>
        <span class="c1"># provided by the TestDiscovery parent class</span>
        <span class="n">current_group_name</span> <span class="o">=</span> <span class="no">RubyIndexer</span><span class="o">::</span><span class="no">Index</span><span class="p">.</span><span class="nf">actual_nesting</span><span class="p">(</span><span class="vi">@nesting</span><span class="p">,</span> <span class="kp">nil</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s2">"::"</span><span class="p">)</span>

        <span class="c1"># The test explorer is populated with a hierarchy of items. Groups have children, which can include other</span>
        <span class="c1"># groups and examples. Listeners should always add newly discovered children to the parent item where they</span>
        <span class="c1"># are discovered. For example:</span>
        <span class="c1">#</span>
        <span class="c1"># class MyTest &lt; MyFrameworkGem::Test</span>
        <span class="c1">#</span>
        <span class="c1">#   # this NestedTest is a child of MyTest</span>
        <span class="c1">#   class NestedTest &lt; MyFrameworkGem::Test</span>
        <span class="c1">#</span>
        <span class="c1">#     # this example is a child of NestedTest</span>
        <span class="c1">#     def test_something; end</span>
        <span class="c1">#   end</span>
        <span class="c1">#</span>
        <span class="c1">#   # This example is a child of MyTest</span>
        <span class="c1">#   def test_something_else; end</span>
        <span class="c1"># end</span>
        <span class="c1">#</span>
        <span class="c1"># Get the current test item from the response builder using the ID. In this case, the immediate group</span>
        <span class="c1"># enclosing will be based on the nesting</span>
        <span class="n">test_item</span> <span class="o">=</span> <span class="vi">@response_builder</span><span class="p">[</span><span class="n">current_group_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="n">test_item</span>

        <span class="c1"># Create the test item for the example. To make IDs unique, always include the group names as part of the ID</span>
        <span class="c1"># since users can define the same exact example name in multiple different groups</span>
        <span class="n">example_item</span> <span class="o">=</span> <span class="no">Requests</span><span class="o">::</span><span class="no">Support</span><span class="o">::</span><span class="no">TestItem</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
          <span class="s2">"</span><span class="si">#{</span><span class="n">current_group_name</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
          <span class="nb">name</span><span class="p">,</span>
          <span class="vi">@uri</span><span class="p">,</span>
          <span class="n">range_from_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
          <span class="ss">framework: :my_framework</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add the example item to both as an explorer entry and code lens</span>
        <span class="n">test_item</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">example_item</span><span class="p">)</span>
        <span class="vi">@response_builder</span><span class="p">.</span><span class="nf">add_code_lens</span><span class="p">(</span><span class="n">example_item</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p class="important">Test item IDs have an implicit formatting requirement: groups must be separated by <code class="language-plaintext highlighter-rouge">::</code> and examples must be separated by <code class="language-plaintext highlighter-rouge">#</code>. This is required even for frameworks that do not use classes and methods to define groups and examples. Including spaces in group or example IDs is allowed.</p> <p>For example, if we have the following test:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTest</span> <span class="o">&lt;</span> <span class="no">MyFrameworkGem</span><span class="o">::</span><span class="no">Test</span>
  <span class="k">class</span> <span class="nc">NestedTest</span> <span class="o">&lt;</span> <span class="no">MyFrameworkGem</span><span class="o">::</span><span class="no">Test</span>
    <span class="k">def</span> <span class="nf">test_something</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>the expected ID for the item representing <code class="language-plaintext highlighter-rouge">test_something</code> should be <code class="language-plaintext highlighter-rouge">MyTest::NestedTest#test_something</code>.</p> <p>For frameworks that do not define test groups using classes, such as RSpec, the listener should not inherit from <code class="language-plaintext highlighter-rouge">RubyLsp::Listeners::TestDiscovery</code>. Instead, the logic can be implemented directly, based on the framework’s specific rules.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">RubyLsp</span>
  <span class="k">module</span> <span class="nn">MyTestFrameworkGem</span>
    <span class="k">class</span> <span class="nc">MySpecListener</span>
      <span class="c1">#: (ResponseBuilders::TestCollection, GlobalState, Prism::Dispatcher, URI::Generic) -&gt; void</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">response_builder</span><span class="p">,</span> <span class="n">global_state</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="c1"># Register on the dispatcher for the node events we are interested in</span>
        <span class="n">dispatcher</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:on_call_node_enter</span><span class="p">)</span>

        <span class="vi">@spec_name_stack</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">end</span>

      <span class="c1">#: (Prism::CallNode) -&gt; void</span>
      <span class="k">def</span> <span class="nf">on_call_node_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">message</span>

        <span class="k">case</span> <span class="n">method_name</span>
        <span class="k">when</span> <span class="s2">"describe"</span><span class="p">,</span> <span class="s2">"context"</span>
          <span class="c1"># Extract the name of this group from the call node's arguments</span>
          <span class="c1"># Create a test item and push it as entries and code lenses</span>
          <span class="c1"># Push the name of this group into the stack, so that we can find which group is current later</span>
        <span class="k">when</span> <span class="s2">"it"</span>
          <span class="c1"># Extract the name of this example from the call node's arguments</span>
          <span class="c1"># Create a test item and push it as entries and code lenses</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="command-resolution"> <a href="#command-resolution" class="anchor-heading" aria-labelledby="command-resolution"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Command resolution </h2> <p>Command resolution is the process of receiving a hierarchy of tests selected in the UI and determining the shell commands required to run them. It’s important that we minimize the number of these commands, to avoid having to spawn too many Ruby processes.</p> <p>For example, this is what consolidated commands could look like when trying to run two specific examples in different frameworks:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Rails style execution (very similar to RSpec)</span>
bin/rails <span class="nb">test</span> /project/test/models/user_test.rb:10:25

<span class="c"># Test Unit style execution based on regexes</span>
bundle <span class="nb">exec </span>ruby <span class="nt">-Itest</span> /test/model_test.rb <span class="nt">--testcase</span> <span class="se">\"</span>/^ModelTest<span class="se">\\</span><span class="nv">$/</span><span class="se">\"</span> <span class="nt">--name</span> <span class="se">\"</span>/test_something<span class="se">\\</span><span class="nv">$/</span>

<span class="c"># Minitest style execution based on regexes</span>
bundle <span class="nb">exec </span>ruby <span class="nt">-Itest</span> /test/model_test.rb <span class="nt">--name</span> <span class="se">\"</span>/^ModelTest#test_something<span class="se">\\</span><span class="nv">$/</span><span class="se">\"</span>
</code></pre></div></div> <p>The add-on’s responsibility is to figure out how to execute test items that are associated with the framework they add support for. Add-ons mark test items with the right framework during discovery and should only resolve items that belong to them.</p> <p>Another important point is that test groups with an empty children array are being fully executed. For example:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A test item hierarchy that means: execute the ModelTest#test_something specific example and no other tests</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="ss">id: </span><span class="s2">"ModelTest"</span><span class="p">,</span>
    <span class="ss">uri: </span><span class="s2">"file:///test/model_test.rb"</span><span class="p">,</span>
    <span class="ss">label: </span><span class="s2">"ModelTest"</span><span class="p">,</span>
    <span class="ss">range: </span><span class="p">{</span>
      <span class="ss">start: </span><span class="p">{</span> <span class="ss">line: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">character: </span><span class="mi">0</span> <span class="p">},</span>
      <span class="ss">end: </span><span class="p">{</span> <span class="ss">line: </span><span class="mi">30</span><span class="p">,</span> <span class="ss">character: </span><span class="mi">3</span> <span class="p">},</span>
    <span class="p">},</span>
    <span class="ss">tags: </span><span class="p">[</span><span class="s2">"framework:minitest"</span><span class="p">,</span> <span class="s2">"test_group"</span><span class="p">],</span>
    <span class="ss">children: </span><span class="p">[</span>
      <span class="p">{</span>
        <span class="ss">id: </span><span class="s2">"ModelTest#test_something"</span><span class="p">,</span>
        <span class="ss">uri: </span><span class="s2">"file:///test/model_test.rb"</span><span class="p">,</span>
        <span class="ss">label: </span><span class="s2">"test_something"</span><span class="p">,</span>
        <span class="ss">range: </span><span class="p">{</span>
          <span class="ss">start: </span><span class="p">{</span> <span class="ss">line: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">character: </span><span class="mi">2</span> <span class="p">},</span>
          <span class="ss">end: </span><span class="p">{</span> <span class="ss">line: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">character: </span><span class="mi">3</span> <span class="p">},</span>
        <span class="p">},</span>
        <span class="ss">tags: </span><span class="p">[</span><span class="s2">"framework:minitest"</span><span class="p">],</span>
        <span class="ss">children: </span><span class="p">[],</span>
      <span class="p">},</span>
    <span class="p">],</span>
  <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># A test item hierarchy that means: execute the entire ModelTest group with all examples and nested groups inside</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="ss">id: </span><span class="s2">"ModelTest"</span><span class="p">,</span>
    <span class="ss">uri: </span><span class="s2">"file:///test/model_test.rb"</span><span class="p">,</span>
    <span class="ss">label: </span><span class="s2">"ModelTest"</span><span class="p">,</span>
    <span class="ss">range: </span><span class="p">{</span>
      <span class="ss">start: </span><span class="p">{</span> <span class="ss">line: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">character: </span><span class="mi">0</span> <span class="p">},</span>
      <span class="ss">end: </span><span class="p">{</span> <span class="ss">line: </span><span class="mi">30</span><span class="p">,</span> <span class="ss">character: </span><span class="mi">3</span> <span class="p">},</span>
    <span class="p">},</span>
    <span class="ss">tags: </span><span class="p">[</span><span class="s2">"framework:minitest"</span><span class="p">,</span> <span class="s2">"test_group"</span><span class="p">],</span>
    <span class="ss">children: </span><span class="p">[],</span>
  <span class="p">},</span>
<span class="p">]</span>
</code></pre></div></div> <p>Add-ons can define the <code class="language-plaintext highlighter-rouge">resolve_test_commands</code> method to define how to resolve the commands required to execute a hierarchy. It is the responsibility of the add-on to filter the hierarchy to only the items that are related to them.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">RubyLsp</span>
  <span class="k">module</span> <span class="nn">MyTestFrameworkGem</span>
    <span class="k">class</span> <span class="nc">Addon</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">RubyLsp</span><span class="o">::</span><span class="no">Addon</span>
      <span class="c1"># Items is the hierarchy of test items to be executed. The return is the list of minimum shell commands required</span>
      <span class="c1"># to run them</span>
      <span class="c1">#: (Array[Hash[Symbol, untyped]]) -&gt; Array[String]</span>
      <span class="k">def</span> <span class="nf">resolve_test_commands</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">items</span><span class="p">.</span><span class="nf">dup</span>

        <span class="k">until</span> <span class="n">queue</span><span class="p">.</span><span class="nf">empty?</span>
          <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">shift</span>
          <span class="n">tags</span> <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="ss">:tags</span><span class="p">])</span>
          <span class="k">next</span> <span class="k">unless</span> <span class="n">tags</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"framework:my_framework"</span><span class="p">)</span>

          <span class="n">children</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="ss">:children</span><span class="p">]</span>

          <span class="k">if</span> <span class="n">tags</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"test_dir"</span><span class="p">)</span>
            <span class="c1"># Handle running entire directories</span>
          <span class="k">elsif</span> <span class="n">tags</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"test_file"</span><span class="p">)</span>
            <span class="c1"># Handle running entire files</span>
          <span class="k">elsif</span> <span class="n">tags</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"test_group"</span><span class="p">)</span>
            <span class="c1"># Handle running groups</span>
          <span class="k">else</span>
            <span class="c1"># Handle running examples</span>
          <span class="k">end</span>

          <span class="n">queue</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="k">unless</span> <span class="n">children</span><span class="p">.</span><span class="nf">empty?</span>
        <span class="k">end</span>

        <span class="n">commands</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>You can refer to implementation examples for <a href="https://github.com/Shopify/ruby-lsp/blob/d86f4d4c567a2a3f8ae6f69caa10e21c4066e23e/lib/ruby_lsp/listeners/test_style.rb#L10">Minitest and Test Unit</a> or <a href="https://github.com/Shopify/ruby-lsp-rails/blob/cb9556d454c8bb20a1a73a99c8deb8788a520007/lib/ruby_lsp/ruby_lsp_rails/rails_test_style.rb#L11">Rails</a>.</p> <h2 id="custom-reporting"> <a href="#custom-reporting" class="anchor-heading" aria-labelledby="custom-reporting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom reporting </h2> <p>To report test execution results to the extension side, frameworks should be hooked up with a custom reporter that sends JSON RPC events. To hook up the custom reporter, add-ons should include all CLI arguments necessary as part of resolving test commands. For example:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">exec </span>my_framework /path/to/project/test/foo_test.rb <span class="nt">--reporter</span> MyFrameworkLspReporter
</code></pre></div></div> <p>To implement the reporter, the Ruby LSP already provides helpers for all of the supported events. It is a matter of ensuring that all events are produced when the test framework performs the associated actions.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># An Lsp reporter for our example test framework</span>
<span class="c1"># See lib/ruby_lsp/test_reporters/lsp_reporter.rb for all available helpers and events</span>
<span class="k">class</span> <span class="nc">MyFrameworkGemLspReporter</span>
  <span class="c1"># Record that an example started running. This shows the example as running in the UI</span>
  <span class="k">def</span> <span class="nf">test_started_running</span><span class="p">(</span><span class="n">test_object</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">test_object</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="n">test_object</span><span class="p">.</span><span class="nf">method_name</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">::</span><span class="no">Generic</span><span class="p">.</span><span class="nf">from_path</span><span class="p">(</span><span class="ss">path: </span><span class="n">test_object</span><span class="p">.</span><span class="nf">file_path</span><span class="p">)</span>
    <span class="no">RubyLsp</span><span class="o">::</span><span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">start_test</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">,</span> <span class="ss">uri: </span><span class="n">uri</span><span class="p">,</span> <span class="ss">line: </span><span class="n">test_object</span><span class="p">.</span><span class="nf">line_number</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Record that an example passed, which shows a green checkmark in the UI</span>
  <span class="k">def</span> <span class="nf">test_passed</span><span class="p">(</span><span class="n">test_object</span><span class="p">)</span>
    <span class="no">RubyLsp</span><span class="o">::</span><span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">record_pass</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">,</span> <span class="ss">uri: </span><span class="n">uri</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Record that an example errored, which shows a red X in the UI and displays the exception message</span>
  <span class="k">def</span> <span class="nf">test_errored</span><span class="p">(</span><span class="n">test_object</span><span class="p">)</span>
    <span class="no">RubyLsp</span><span class="o">::</span><span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">record_skip</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">,</span> <span class="ss">uri: </span><span class="n">uri</span><span class="p">,</span> <span class="ss">message: </span><span class="s2">"Test errored because..."</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Record that an example failed, which shows a red X in the UI and displays the failure message</span>
  <span class="k">def</span> <span class="nf">test_failed</span><span class="p">(</span><span class="n">test_object</span><span class="p">)</span>
    <span class="no">RubyLsp</span><span class="o">::</span><span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">record_fail</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">,</span> <span class="ss">uri: </span><span class="n">uri</span><span class="p">,</span> <span class="ss">message: </span><span class="s2">"Test failed because..."</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Record that an example skipped, which shows a skipped status in the UI</span>
  <span class="k">def</span> <span class="nf">test_skipped</span><span class="p">(</span><span class="n">test_object</span><span class="p">)</span>
    <span class="no">RubyLsp</span><span class="o">::</span><span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">record_skip</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">,</span> <span class="ss">uri: </span><span class="n">uri</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Normal shutdown flow, when all tests ran without crashing the test process itself</span>
  <span class="k">def</span> <span class="nf">after_all_tests_finished_running</span>
    <span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">shutdown</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># This is required to cleanup the explorer in case the normal execution of tests errors. For example, if the user</span>
<span class="c1"># writes a bad require and the test process crashes before even starting to run examples</span>
<span class="no">MyFrameworkGem</span><span class="p">.</span><span class="nf">after_run_is_completed</span> <span class="k">do</span>
  <span class="no">RubyLsp</span><span class="o">::</span><span class="no">LspReporter</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">at_exit</span>
<span class="k">end</span>
</code></pre></div></div> <p class="important">The IDs and URIs used to report results <strong>must match</strong> the ones used during test discovery to ensure that the outcomes are associated with the right items.</p> <p class="note">If your test framework is based on Minitest or Test Unit and leverages their reporting structure, you may not need to add custom reporters. Instead, you can simply rely on the ones automatically registered and provided by the Ruby LSP.</p> <p>See our reporters for <a href="https://github.com/Shopify/ruby-lsp/blob/main/lib/ruby_lsp/test_reporters/minitest_reporter.rb">Minitest</a> and <a href="https://github.com/Shopify/ruby-lsp/blob/main/lib/ruby_lsp/test_reporters/test_unit_reporter.rb">Test Unit</a> as examples.</p> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
