#!/bin/bash

if [ $# -ne 1 ]; then
  echo "Usage: $0 <socket-name>"
  exit 1
fi

WORKSPACE_NAME="$1"
SOCKET_NAME="$WORKSPACE_NAME"
SOCKET_PATH="/tmp/ruby-mcp/$SOCKET_NAME"
LOG_PATH="/tmp/ruby-mcp/$SOCKET_NAME.log"

# Ensure the directory exists
mkdir -p /tmp/ruby-mcp

echo "Bridge started for workspace: $WORKSPACE_NAME" >> "$LOG_PATH"

while IFS= read -r line; do
  echo "================================" >> "$LOG_PATH"
  echo "Input JSON: $line" >> "$LOG_PATH"

  # Send to Unix domain socket using netcat (nc)
  response=$(echo -e "POST /mcp HTTP/1.1\r\nContent-Type: application/json\r\nContent-Length: ${#line}\r\n\r\n$line" | \
    nc -w 2 -U "$SOCKET_PATH" 2>/dev/null) || {
    echo "Socket communication failed" >> "$LOG_PATH"
    continue
  }

  # Extract the JSON response by removing HTTP headers
  json_response=$(echo "$response" | awk 'BEGIN{RS="\r\n\r\n"} NR==2')

  echo "--------------------------------" >> "$LOG_PATH"
  echo "Response JSON: $json_response" >> "$LOG_PATH"

  echo "$json_response"
done
